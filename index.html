<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Maze Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background: #101828; margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #unity-container { width: 100%; max-width: 960px; margin: 40px auto 0 auto; }
    #unity-canvas { width: 100%; background: #222; }
    #play-button-container {
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #play-button {
      padding: 12px 24px; font-size: 18px; border-radius: 8px; border: none;
      background: linear-gradient(180deg, #2d8cff 0%, #007AFF 100%);
      color: #fff; cursor: pointer; box-shadow: 0 2px 8px #007aff33;
      font-weight: 600; letter-spacing: .02em;
    }
    #leaderboard-container {
      max-width: 410px;
      margin: 32px auto 0 auto;
      background: rgba(20,28,40,0.95);
      border-radius: 24px;
      box-shadow: 0 2px 16px #00102033;
      padding: 18px 0 24px 0;
    }
    #leaderboard-tabs {
      display: flex; justify-content: space-around; margin-bottom: 16px;
    }
    #leaderboard-tabs button {
      background: #181f2a;
      color: #fff; border: none; padding: 10px 18px;
      border-radius: 15px; font-size: 15px; cursor: pointer;
      font-weight: 600; margin: 0 2px; transition: background 0.2s;
    }
    #leaderboard-tabs button.active {
      background: linear-gradient(180deg,#2d8cff,#007aff);
      color: #fff;
      box-shadow: 0 2px 8px #007aff33;
    }
    .leaderboard-tab { display: none; }
    .leaderboard-tab.active { display: block; }
    .leaderboard-list { padding: 0 10px; }
    .leaderboard-row {
      display: flex; align-items: center;
      background: #232c3c; border-radius: 14px;
      margin: 8px 0; padding: 10px 14px;
      box-shadow: 0 1px 4px #00102022;
      min-height: 58px;
      position: relative;
    }
    .leaderboard-row.gold { background: linear-gradient(90deg,#ffe399 80%,#ffde6e 100%); color:#a07610; font-weight: bold;}
    .leaderboard-row.silver { background: linear-gradient(90deg,#d2dde8 80%,#b6c1d3 100%); color:#42516d; font-weight: bold;}
    .leaderboard-row.bronze { background: linear-gradient(90deg,#f3c195 80%,#e8a45c 100%); color:#855f33; font-weight: bold;}
    .leaderboard-rank {
      font-size: 22px; width: 32px; font-weight: bold; margin-right: 10px; text-align: center;
    }
    .leaderboard-photo {
      width: 40px; height: 40px; border-radius: 50%;
      margin-right: 14px; border: 2.5px solid #364160; object-fit: cover; background: #252525;
    }
    .leaderboard-name {
      flex: 1; color: inherit; font-size: 17px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .leaderboard-score {
      font-size: 19px; font-weight: bold; color: inherit; margin-left: 8px;
    }
    @media (max-width: 520px) {
      #leaderboard-container { max-width: 97vw; }
      .leaderboard-row { min-height: 42px; padding: 7px 7px;}
      .leaderboard-photo { width: 33px; height: 33px;}
      .leaderboard-name, .leaderboard-score { font-size: 15px;}
      .leaderboard-rank { font-size: 17px; width: 22px;}
    }
  </style>
</head>
<body>
  <div id="unity-container">
    <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
  </div>
  <div id="play-button-container">
    <button id="play-button">Play</button>
  </div>

  <!-- LEADERBOARD UI -->
  <div id="leaderboard-container">
    <div id="leaderboard-tabs">
      <button data-tab="group" class="active">All-Time Chat</button>
      <button data-tab="global">All-Time Spelers</button>
      <button data-tab="chats">Beste Groepen</button>
    </div>
    <div id="leaderboard-content">
      <div data-content="group" class="leaderboard-tab active">
        <div class="leaderboard-list" id="lb-group"></div>
      </div>
      <div data-content="global" class="leaderboard-tab">
        <div class="leaderboard-list" id="lb-global"></div>
      </div>
      <div data-content="chats" class="leaderboard-tab">
        <div class="leaderboard-list" id="lb-chats"></div>
      </div>
    </div>
  </div>

  <script>
    // Dummy data voor demo â€” Vervang met API-calls naar je eigen backend!
    const leaderboardData = {
      group: [],
      global: [],
      chats: []
    };
async function fetchBestChatsLeaderboard(game_id, limit=10) {
  let url = `https://highscoregamingbot.pythonanywhere.com/chat_leaderboard?game_id=${encodeURIComponent(game_id)}&limit=${limit}`;
  let resp = await fetch(url);
  let data = await resp.json();
  // Verwerk het juiste veld!
  return data.scores || data || [];
}
async function loadChatsLeaderboard() {
  const gameId = 'maze_runner';
  const chats = await fetchBestChatsLeaderboard(gameId);
  leaderboardData.chats = chats.map((entry, idx) => ({
    rank: idx+1,
    name: entry.title || entry.username || entry.chat_id, // groepsnaam, anders id
    score: entry.score,
    photo: '' // Voeg later groepsfoto toe
  }));
  renderLeaderboard('chats', 'lb-chats');
}
async function fetchChatLeaderboard(game_id, chat_id, limit=10) {
  let url = `https://highscoregamingbot.pythonanywhere.com/alltime_leaderboard?game_id=${encodeURIComponent(game_id)}&chat_id=${encodeURIComponent(chat_id)}&limit=${limit}`;
  let resp = await fetch(url);
  let data = await resp.json();
  return data.scores || [];
}
async function loadGroupLeaderboard() {
  const chatId = getDecodedChatId();         // dit bestaat al in je script!
  const gameId = 'maze_runner';              // of pak hem dynamisch, maar voor nu even hard
  const group = await fetchChatLeaderboard(gameId, chatId);
  leaderboardData.group = group.map((entry, idx) => ({
    rank: idx+1,
    name: ((entry.first_name || '') + ' ' + (entry.last_name || '')).trim() || entry.username || '-',
    score: entry.score,
    photo: '' // Profielfoto kun je later toevoegen als je wilt
  }));
  renderLeaderboard('group', 'lb-group');
}
    async function loadGlobalLeaderboard() {
  const gameId = 'maze_runner'; // Of pak hem dynamisch
  const global = await fetchGlobalLeaderboard(gameId);
  leaderboardData.global = global.map((entry, idx) => ({
    rank: idx+1,
    name: ((entry.first_name || '') + ' ' + (entry.last_name || '')).trim() || entry.username || '-',
    score: entry.score,
    photo: ''
  }));
  renderLeaderboard('global', 'lb-global');
}

    async function fetchGlobalLeaderboard(game_id, limit=10) {
  let url = `https://highscoregamingbot.pythonanywhere.com/alltime_leaderboard?game_id=${encodeURIComponent(game_id)}&limit=${limit}`;
  let resp = await fetch(url);
  let data = await resp.json();
  return data.scores || [];
}
    function renderLeaderboard(type, listId) {
      let rows = '';
      leaderboardData[type].forEach((entry, i) => {
        let rankClass = i === 0 ? "gold" : i === 1 ? "silver" : i === 2 ? "bronze" : "";
        let safePhoto = entry.photo || "https://api.dicebear.com/7.x/identicon/svg?seed=" + encodeURIComponent(entry.name);
        rows += `
          <div class="leaderboard-row ${rankClass}">
            <span class="leaderboard-rank">${entry.rank}</span>
            <img class="leaderboard-photo" src="${safePhoto}" alt="pf">
            <span class="leaderboard-name">${entry.name}</span>
            <span class="leaderboard-score">${entry.score}</span>
          </div>
        `;
      });
      document.getElementById(listId).innerHTML = rows;
    }

    loadGroupLeaderboard();
    loadGlobalLeaderboard();
    loadChatsLeaderboard();

    // Tabs click/swipe
    document.querySelectorAll("#leaderboard-tabs button").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll("#leaderboard-tabs button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        let tab = btn.getAttribute("data-tab");
        document.querySelectorAll(".leaderboard-tab").forEach(c => c.classList.remove("active"));
        document.querySelector(`[data-content='${tab}']`).classList.add("active");
      };
    });

    // Basic swipe detection
    let startX = 0;
    let tabs = ["group", "global", "chats"];
    let currentTab = 0;
    document.getElementById("leaderboard-content").addEventListener("touchstart", function(e){
      startX = e.touches[0].clientX;
    });
    document.getElementById("leaderboard-content").addEventListener("touchend", function(e){
      let dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 40) {
        currentTab += dx < 0 ? 1 : -1;
        if (currentTab < 0) currentTab = 0;
        if (currentTab > 2) currentTab = 2;
        let btns = document.querySelectorAll("#leaderboard-tabs button");
        btns[currentTab].click();
      }
    });

    // Unity WebGL bootstrapping (zoals je huidige code)
    var canvas = document.getElementById("unity-canvas");
    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/mazerunner.loader.js";
    var config = {
      dataUrl: buildUrl + "/mazerunner.data",
      frameworkUrl: buildUrl + "/mazerunner.framework.js",
      codeUrl: buildUrl + "/mazerunner.wasm",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "Highscore Gaming",
      productName: "Maze",
      productVersion: "0.1"
    };

    function getDecodedChatId() {
      const initData = Telegram.WebApp.initDataUnsafe || {};
      if (initData.start_param) {
        let b64 = initData.start_param.replace(/-/g, '+').replace(/_/g, '/');
        while (b64.length % 4) b64 += '=';
        try { return atob(b64); } catch (e) { return ""; }
      }
      return "";
    }
    function getGameIdFromUrl() {
      let parts = window.location.pathname.split("/").filter(Boolean);
      return parts.length > 0 ? parts[0] : "";
    }
    const initData = Telegram.WebApp.initDataUnsafe || {};
    const chatId = getDecodedChatId();
    const gameId = getGameIdFromUrl();
    const telegramId = initData.user?.id || "";
    const username = initData.user?.username || "";
    const firstName = initData.user?.first_name || "";
    const lastName = initData.user?.last_name || "";
    const unityData = `${telegramId};${username};${chatId};${firstName};${lastName};${gameId}`;

    // ---- Unity direct laden bij paginalaad ----
    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        // Optioneel: load bar visuals
      }).then((unityInstance) => {
        // ---- Telegram-data direct sturen ----
        unityInstance.SendMessage("TelegramParams", "SetTelegramUserData", unityData);

        // ---- Play-knop nu tonen ----
        document.getElementById("play-button-container").style.display = "block";

        // Play event: canvas fullscreen + leaderboard weg
        document.getElementById("play-button").onclick = function() {
          document.getElementById("play-button-container").style.display = "none";
          document.getElementById("leaderboard-container").style.display = "none";
          document.getElementById("unity-container").style.position = "fixed";
          document.getElementById("unity-container").style.top = 0;
          document.getElementById("unity-container").style.left = 0;
          // Stretch canvas
          canvas.style.width = window.innerWidth + "px";
          canvas.style.height = window.innerHeight + "px";
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          canvas.style.position = "absolute";
          canvas.style.left = "0";
          canvas.style.top = "0";
          document.body.style.background = "#000";
        };
      });
    };
    document.body.appendChild(script);
    // ---- Einde Unity direct laden ----

    window.addEventListener('resize', function() {
      // Optioneel: canvas herstr.
      // (Alleen als je dat wilt na Play)
    });
  </script>
</body>
</html>
