<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <title>Maze Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Global resets */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

    /* Unity container */
    #unity-container { position: absolute; top: 0; left: 0; width: 100%; height: 60vh; background: #111; }
    canvas { width: 100%; height: 100%; display: block; }
    #play-button-container { position: absolute; top: 16px; right: 16px; }
    #play-button { padding: 8px 16px; background: #0af; border: none; border-radius: 6px; color: #000; font-weight: 600; cursor: pointer; }

    /* Leaderboard overlay */
    #leaderboard-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 40vh; background: rgba(10,10,30,0.9); border-top: 2px solid #0af; display: flex; align-items: center; justify-content: center; }
    #leaderboard { width: 90%; max-width: 600px; height: 90%; background: #111; border: 1px solid #0af; border-radius: 12px; box-shadow: 0 0 20px #0af; overflow: hidden; position: relative; }
    .lb-header { position: absolute; top: 12px; width: 100%; text-align: center; font-size: 1.2em; letter-spacing: .05em; }
    .lb-list { position: absolute; top: 48px; bottom: 24px; width: 100%; overflow-y: auto; }
    .lb-row { display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #0af33; }
    .lb-row:nth-child(1) { background: linear-gradient(90deg,#ffe399,#ffde6e); color: #000; }
    .lb-row:nth-child(2) { background: linear-gradient(90deg,#d2dde8,#b6c1d3); color: #000; }
    .lb-row:nth-child(3) { background: linear-gradient(90deg,#f3c195,#e8a45c); color: #000; }
    .lb-row:nth-child(n+4) { background: #222; }

    /* Swipe arrows */
    .arrow { position: absolute; top: 50%; transform: translateY(-50%); color: #0af; font-size: 2em; cursor: pointer; user-select: none; }
    #arrow-left { left: 12px; }
    #arrow-right { right: 12px; }
  </style>
</head>
<body>
  <div id="unity-container">
    <canvas id="unity-canvas"></canvas>
    <div id="play-button-container"><button id="play-button">Play</button></div>
  </div>
  <div id="leaderboard-container">
    <div id="leaderboard">
      <div id="arrow-left" class="arrow">❮</div>
      <div id="arrow-right" class="arrow">❯</div>
      <div class="lb-header" id="lb-header"></div>
      <div class="lb-list" id="lb-list"></div>
    </div>
  </div>
  <script>
    const API_BASE = 'https://highscoregamingbot.pythonanywhere.com';
    const PARAMS = new URLSearchParams(window.location.search);
    const GAME_ID = PARAMS.get('game_id') || 'maze_runner';
    const CHAT_ID = PARAMS.get('chat_id') || '';

    const ENDPOINTS = [
      { title: 'All-Time Chat',    url: `${API_BASE}/alltime_leaderboard?game_id=${GAME_ID}&chat_id=${CHAT_ID}&limit=10` },
      { title: 'All-Time Global',  url: `${API_BASE}/global_alltime_leaderboard?game_id=${GAME_ID}&limit=10` },
      { title: 'All-Time Groups',  url: `${API_BASE}/alltime_chat_leaderboard?game_id=${GAME_ID}&limit=10` },
      { title: 'Best Chat Leader', url: `${API_BASE}/best_chat_leaderboard?limit=10` }
    ];

    let currentIndex = 0;
    const headerEl = document.getElementById('lb-header');
    const listEl   = document.getElementById('lb-list');

    async function loadLeaderboard(index) {
      const ep = ENDPOINTS[index];
      headerEl.textContent = ep.title;
      try {
        const res = await fetch(ep.url, { cache: 'no-store' });
        const json = await res.json();
        const data = json.scores || [];
        listEl.innerHTML = data.length > 0
          ? data.map((row, i) => {
              const name = row.first_name
                ? `${row.first_name} ${row.last_name || ''}`.trim()
                : (row.username || row.chat_title || row.chat_id || '—');
              const score = row.score ?? row.points ?? row.total_score ?? 0;
              return `<div class="lb-row">${i+1}. ${name}<span>${score}</span></div>`;
            }).join('')
          : `<div class="lb-row">No data</div>`;
      } catch (e) {
        listEl.innerHTML = `<div class="lb-row">Error loading</div>`;
        console.error('Error fetching leaderboard:', e);
      }
    }

    function showIndex(delta) {
      currentIndex = (currentIndex + delta + ENDPOINTS.length) % ENDPOINTS.length;
      loadLeaderboard(currentIndex);
    }

    document.getElementById('arrow-left').addEventListener('click', () => showIndex(-1));
    document.getElementById('arrow-right').addEventListener('click', () => showIndex(1));

    // Swipe detection on leaderboard container
    let startX = 0;
    const lbContainer = document.getElementById('leaderboard');
    lbContainer.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    lbContainer.addEventListener('touchend', e => {
      const diff = e.changedTouches[0].clientX - startX;
      if (diff > 40) showIndex(-1);
      if (diff < -40) showIndex(1);
    });

    // Initial leaderboard load
    loadLeaderboard(0);

    // Unity WebGL loader
    const canvas = document.getElementById('unity-canvas');
    canvas.width = window.innerWidth;
    canvas.height = document.getElementById('unity-container').clientHeight;
    const buildUrl = 'Build';
    const config = {
      dataUrl: `${buildUrl}/${GAME_ID}.data`,
      frameworkUrl: `${buildUrl}/${GAME_ID}.framework.js`,
      codeUrl: `${buildUrl}/${GAME_ID}.wasm`,
      streamingAssetsUrl: 'StreamingAssets',
      companyName: 'Highscore Gaming', productName: GAME_ID, productVersion: '0.1'
    };

    const unityLoader = document.createElement('script');
    unityLoader.src = `${buildUrl}/${GAME_ID}.loader.js`;
    unityLoader.onload = () => {
      createUnityInstance(canvas, config, progress => {})
        .then(unity => {
          document.getElementById('play-button-container').style.display = 'block';
        })
        .catch(err => console.error('Unity init failed:', err));
    };
    document.body.appendChild(unityLoader);
  </script>
</body>
</html>
