<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <title>Maze Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background: #000; margin: 0; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    #unity-container { position: relative; width: 100%; height: 60vh; background: #111; }
    #unity-canvas { width: 100%; height: 100%; display: block; }
    #play-button-container { position: absolute; top: 10px; right: 10px; }
    #play-button { padding: 10px 20px; background: #0af; border:none; border-radius: 6px; color:#000; font-weight:600; cursor:pointer; }

    /* Leaderboard overlay below Unity */
    #leaderboard-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 40vh; background: rgba(10,10,30,0.9); border-top: 2px solid #0af; display: flex; align-items:center; justify-content:center; }
    #leaderboard { width: 90%; max-width: 600px; height: 90%; background: #111; border: 1px solid #0af; border-radius: 12px; box-shadow: 0 0 20px #0af; overflow: hidden; position: relative; }
    .lb-header { position: absolute; top: 10px; width: 100%; text-align:center; font-size:1.2em; letter-spacing: .05em; }
    .lb-list { position: absolute; top: 50px; bottom: 20px; width: 100%; overflow-y: auto; }
    .lb-row { display:flex; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #0af33; }
    .lb-row:nth-child(1) { background: linear-gradient(90deg,#ffe399,#ffde6e); color:#000; }
    .lb-row:nth-child(2) { background: linear-gradient(90deg,#d2dde8,#b6c1d3); color:#000; }
    .lb-row:nth-child(3) { background: linear-gradient(90deg,#f3c195,#e8a45c); color:#000; }
    .lb-row:nth-child(n+4) { background: #222; }

    /* Swipe arrows */
    .arrow { position: absolute; top:50%; width:30px; height:30px; margin-top:-15px; color:#0af; font-size:2em; cursor:pointer; user-select:none; }
    #arrow-left { left:10px; }
    #arrow-right { right:10px; }
  </style>
</head>
<body>
  <div id="unity-container">
    <canvas id="unity-canvas"></canvas>
    <div id="play-button-container"><button id="play-button">Play</button></div>
  </div>
  <div id="leaderboard-container">
    <div id="leaderboard">
      <div id="arrow-left" class="arrow">❮</div>
      <div id="arrow-right" class="arrow">❯</div>
      <div class="lb-header" id="lb-header"></div>
      <div class="lb-list" id="lb-list"></div>
    </div>
  </div>
  <script>
    const apiBase = 'https://highscoregamingbot.pythonanywhere.com';
    const endpoints = [
      { name: 'All-Time Chat', url: params => `${apiBase}/alltime_leaderboard?game_id=${params.game}&chat_id=${params.chat}&limit=10` },
      { name: 'All-Time Global', url: params => `${apiBase}/global_alltime_leaderboard?game_id=${params.game}&limit=10` },
      { name: 'Chat Leaderboard', url: params => `${apiBase}/alltime_chat_leaderboard?game_id=${params.game}&limit=10` },
      { name: 'Best Chat Leader', url: params => `${apiBase}/best_chat_leaderboard?limit=10` }
    ];
    let current = 0;
    const header = document.getElementById('lb-header');
    const listEl = document.getElementById('lb-list');
    const params = { game: new URLSearchParams(location.search).get('game_id') || 'maze_runner', chat: new URLSearchParams(location.search).get('chat_id') || '' };

    async function loadLeaderboard(i) {
      header.textContent = endpoints[i].name;
      const url = endpoints[i].url(params);
      try {
        const res = await fetch(url);
        const json = await res.json();
        const data = json.scores || [];
        listEl.innerHTML = data.length ? data.map((row, idx) => {
          const name = row.first_name ? `${row.first_name} ${row.last_name || ''}`.trim() : (row.username || row.chat_title || row.chat_id);
          const score = row.score ?? row.points ?? row.total_score;
          return `<div class="lb-row">${idx+1}. ${name}<span>${score}</span></div>`;
        }).join('') : '<div class="lb-row">No data</div>';
      } catch (e) {
        listEl.innerHTML = '<div class="lb-row">Error loading</div>';
      }
    }

    function show(i) {
      current = (i + endpoints.length) % endpoints.length;
      loadLeaderboard(current);
    }

    document.getElementById('arrow-left').onclick = () => show(current - 1);
    document.getElementById('arrow-right').onclick = () => show(current + 1);
    // Swipe
    let startX = 0;
    listEl.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    listEl.addEventListener('touchend', e => {
      const diff = e.changedTouches[0].clientX - startX;
      if (diff > 50) show(current -1);
      if (diff < -50) show(current +1);
    });

    // Initial load
    show(0);

    // Unity loader (unchanged)
    const canvas = document.getElementById('unity-canvas');
    canvas.width = window.innerWidth;
    canvas.height = document.getElementById('unity-container').clientHeight;
    const buildUrl = 'Build';
    const gameId = params.game;
    const config = { dataUrl:`${buildUrl}/${gameId}.data`, frameworkUrl:`${buildUrl}/${gameId}.framework.js`, codeUrl:`${buildUrl}/${gameId}.wasm`, streamingAssetsUrl:'StreamingAssets', companyName:'Highscore Gaming',productName:gameId,productVersion:'0.1' };
    const script = document.createElement('script');
    script.src = `${buildUrl}/${gameId}.loader.js`;
    script.onload = () => createUnityInstance(canvas, config, null)
      .then(unity => document.getElementById('play-button-container').style.display='block')
      .catch(err=>console.error(err));
    document.body.appendChild(script);
  </script>
</body>
</html>
